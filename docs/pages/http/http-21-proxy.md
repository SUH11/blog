# HTTP的代理服务

中间人：代理



1. 代理服务

   所谓的“代理服务”就是指服务本身不生产内容，而是处于中间位置转发上下游的请求和响应

   具有双重身份：面向下游的用户时，表现为服务器，代表源服务器响应客户端的请求；而面向上游的源服务器时，又表现为客户端，代表客户端发送请求。



2. 代理的作用
   $$
   计算机科学领域里的任何问题，都可以通过引入一个中间层来解决
   如果一个中间层解决不了问题，那就再加一个中间层
   $$
   对上：屏蔽真实客户端

   对下：屏蔽真实服务器

   (1) 负载均衡

   ​	轮询、一致性哈希

   (2) 健康检查：使用“心跳”等机制监控后端服务器，发现有故障就及时“踢出”集群，保证服务高可用

   (3) 安全防护：限制 IP 地址或流量，抵御网络攻击和过载

   (4) 加密卸载：外网SSL/TLS，内网不加密，降低成本

   (5) 数据过滤：拦截上下行的数据，任意指定策略修改请求或者响应

   (6) 内容缓存：暂存、复用服务器响应



3. 代理相关头字段

   - Via：标明代理的身份
   - X-Forwarded-For：追加的是请求方的 IP 地址（第一个是客户端地址）
   - X-Real-IP：客户端真实IP

   例子：proxy

   ![image-20200622165311712](https://static001.geekbang.org/resource/image/c5/e7/c5aa6d5f82e8cc1a35772293972446e7.png)

   抓包数据：

   ![image-20200622165330311](https://static001.geekbang.org/resource/image/5a/54/5a247e9e5bf66f5ac3316fddf4e2b254.png)

   从抓包里就可以清晰地看出代理与客户端、源服务器的通信过程：

   1. 客户端 55061 先用三次握手连接到代理的 80 端口，然后发送 GET 请求；
   2. 代理不直接生产内容，所以就代表客户端，用 55063 端口连接到源服务器，也是三次握手；
   3. 代理成功连接源服务器后，发出了一个 HTTP/1.0 的 GET 请求；
   4. 因为 HTTP/1.0 默认是短连接，所以源服务器发送响应报文后立即用四次挥手关闭连接；
   5. 代理拿到响应报文后再发回给客户端，完成了一次代理服务。

   > 注：X-Forwarded-For和X-Real-IP不一定可靠



4. 代理协议：The PROXY protocol

   由知名的代理软件 HAProxy 所定义，也是一个“事实标准”，被广泛采用

```bash
#     TCP4:客户端ip地址类型 请求方地址	应答方地址	请求方端口		应答方端口\r\n结束
PROXY TCP4 1.1.1.1 2.2.2.2 55555 80\r\n
GET / HTTP/1.1\r\n
Host: www.xxx.com\r\n
\r\n
```





### 总结

1. HTTP 代理就是客户端和服务器通信链路中的一个中间环节，为两端提供“代理服务”；
2. 代理处于中间层，为 HTTP 处理增加了更多的灵活性，可以实现负载均衡、安全防护、数据过滤等功能；
3. 代理服务器需要使用字段“Via”标记自己的身份，多个代理会形成一个列表；
4. 如果想要知道客户端的真实 IP 地址，可以使用字段“X-Forwarded-For”和“X-Real-IP”；
5. 专门的“代理协议”可以在不改动原始报文的情况下传递客户端的真实 IP。



































