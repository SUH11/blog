# CDN：加速我们的网络服务



协议方面：HTTPS 强化通信链路安全、HTTP/2 优化传输效率

应用方面：Nginx/OpenResty 提升网站服务能力，WAF 抵御网站入侵攻击

应用领域：内容分发网络（CND）



1. 为什么要有网络加速？

   - 地理距离：物理位置

     > 光速是有限的，虽然每秒 30 万公里，但这只是真空中的上限，在实际的电缆、光缆中的速度会下降到原本的三分之二左右，也就是 20 万公里 / 秒，这样一来，地理位置的距离导致的传输延迟就会变得比较明显了。

   - 运营商网络

     - 网络内部的沟通很顺畅，但网络之间却只有很少的联通点。如果你在 A 网络，而网站在 C 网络，那么就必须“跨网”传输，和成千上万的其他用户一起去“挤”连接点的“独木桥”。而带宽终究是有限的，能抢到多少只能看你的运气。

   - 路由转发

     > 网络中还存在许多的路由器、网关，数据每经过一个节点，都要停顿一下，在二层、三层解析转发，这也会消耗一定的时间，带来延迟



2. 什么是CDN？

   专门为解决“长距离”上网络访问速度慢而诞生的一种网络应用服务。

   - 最核心原则是“**就近访问**”
     - 如果用户能够在本地几十公里的距离之内获取到数据，那么时延就基本上变成 0 了。
     - 所以 CDN 投入了大笔资金，在全国、乃至全球的各个大枢纽城市都建立了机房，部署了大量拥有高存储高带宽的节点，构建了一个专用网络。
   - 缓存代理
     - 使用“推”或者“拉”的手段，把源站的内容逐级缓存到网络的每一个节点上。
     - 用户在上网的时候就不直接访问源站，而是访问离他“最近的”一个 CDN 节点：**边缘节点**
     - 缓存内容
       - 静态资源
         - 数据内容“静态不变”，任何时候来访问都是一样的，比如图片、音频
       - 动态资源
         - 数据内容是“动态变化”的，也就是由后台服务计算生成的，每次访问都不一样，比如商品的库存、微博的粉丝数等。
         - 可以利用：**Cache-Control**缓存短暂时间

   

   CDN：**我们不生产内容，我们只是内容的搬运工。**

   ​	

3. CDN 的负载均衡

   - 全局负载均衡（GSLB）：DNS负载均衡

     > DNS（第六讲）

     - CDN 的“大脑”

     - 主要的职责是挑选出一个“最佳”节点提供服务

     - 权威 DNS 返回的不是 IP 地址，而是一个 **CNAME**( Canonical Name ) 别名记录，指向的就是 CDN 的 GSLB

       因为没拿到 IP 地址，于是本地 DNS 就会向 GSLB 再发起请求，这样就进入了 CDN 的全局负载均衡系统，开始“智能调度”

       - 看用户的 IP 地址，查表得知地理位置，找相对最近的边缘节点；
       - 看用户所在的运营商网络，找相同网络的边缘节点；
       - 检查边缘节点的负载情况，找负载较轻的节点；
       - 其他，比如节点的“健康状况”、服务能力、带宽、响应时间等。

     - 难点：何找到“最近的”边缘节点，对整个 CDN 网络进行“负载均衡”

   - 缓存系统

     > 缓存代理（第21 22讲）

     - CDN 的“心脏”

     - 衡量 CDN 服务质量的指标：“**命中率**”和“**回源率**”

       > 的商业 CDN 命中率都在 90% 以上，相当于把源站的服务能力放大了 10 倍以上。

       

#### 小结

​		CDN 发展到现在已经有二十来年的历史了，早期的 CDN 功能比较简单，只能加速静态资源。

​		随着这些年 Web 2.0、HTTPS、视频、直播等新技术、新业务的崛起，它也在不断进步，增加了很多的新功能，比如 **SSL 加速**、**内容优化（数据压缩、图片格式转换、视频转码）**、**资源防盗链**、**WAF 安全防护**等等。

WAF：防火墙



### 总结

1. 由于客观地理距离的存在，直连网站访问速度会很慢，所以就出现了 CDN；
2. CDN 构建了全国、全球级别的专网，让用户就近访问专网里的边缘节点，降低了传输延迟，实现了网站加速；
3. GSLB 是 CDN 的“大脑”，使用 DNS 负载均衡技术，智能调度边缘节点提供服务；
4. 缓存系统是 CDN 的“心脏”，使用 HTTP 缓存代理技术，缓存命中就返回给用户，否则就要回源。























