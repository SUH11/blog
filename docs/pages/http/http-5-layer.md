# 常说的“四层”和“七层”到底是什么？



TCP/IP 协议是一个“有层次的协议栈”

什么“四层负载均衡”“七层负载均衡”，什么“二层转发”“三层路由”……



1. TCP/IP 网络分层模型

   ![TCP/IP 网络分层模型](https://static001.geekbang.org/resource/image/2b/03/2b8fee82b58cc8da88c74a33f2146703.png)

   层次顺序是“**从下往上**”数的

   - 第一层叫“**链接层**”
     - 负责在以太网、WiFi 这样的底层网络上发送原始数据包
     - 也叫Mac层
     - 传输单位是：帧
   - 第二层叫“**网际层**”或者“**网络互连层**”
     - **IP协议**在这一层
     - 用 IP 地址取代 MAC 地址，把许许多多的局域网、广域网连接成一个虚拟的巨大网络
     - 传输单位是：包
   - 第三层叫“**传输层**”
     - 保证数据在 IP 地址标记的两点之间“可靠”地传输
     - **TCP协议**：传输单位是段（segment）
     - **UDP协议**
   - 第四层叫“应用层”
     - 有各种面向具体应用的协议
     - 有Telnet、SSH、FTP、SMTP、HTTP等等
     - HTTP传输单位是：消息或者报文



2. OSI 网络分层模型

   OSI：开放式系统互联通信参考模型（Open System Interconnection Reference Model）

   TCP/IP 发明于 1970 年代，当时除了它还有很多其他的网络协议，整个网络世界比较混乱。

   这个时候国际标准组织（ISO）注意到了这种现象，感觉“野路子”太多，就想要来个“大一统”。于是设计出了一个新的网络分层模型，想用这个新框架来统一既存的各种网络协议。

   ![OSI 网络分层模型](https://static001.geekbang.org/resource/image/3a/dc/3abcf1462621ff86758a8d9571c07cdc.png)

   OSI 模型分成了七层

   - 第一层：物理层，网络的物理形式
     - 例如电缆、光纤、网卡、集线器等等；
   - 第二层：数据链路层
     - 它基本相当于 TCP/IP 的链接层（Mac层）；
   - 第三层：网络层，相当于 TCP/IP 里的网际层（IP）；
   - 第四层：传输层，相当于 TCP/IP 里的传输层（TCP/UDP）；
   - 第五层：会话层，维护网络中的连接状态，即保持会话和同步；
   - 第六层：表示层，把数据转换为合适、可理解的语法和语义；
   - 第七层：应用层，面向具体的应用传输数据（HTTP）。

   这种说法只是“理论上”的层次，并不是与现实完全对应。



3. 两个分层模型的映射关系

   ![两个分层模型的映射关系](https://static001.geekbang.org/resource/image/9d/94/9d9b3c9274465c94e223676b6d434194.png)

   - 第一层：物理层，TCP/IP 里无对应；
   - 第二层：数据链路层，对应 TCP/IP 的链接层；
   - 第三层：网络层，对应 TCP/IP 的网际层；
   - 第四层：传输层，对应 TCP/IP 的传输层；
   - 第五、六、七层：统一对应到 TCP/IP 的应用层。

   “**四层负载均衡**”就是指工作在传输层上，基于 TCP/IP 协议的特性，例如 IP 地址、端口号等实现对后端服务器的负载均衡。

   “**七层负载均衡**”就是指工作在应用层上，看到的是 HTTP 协议，解析 HTTP 报文里的 URI、主机名、资源类型等数据，再用适当的策略转发给后端服务器。



### 总结

1. TCP/IP 分为四层，核心是二层的 IP 和三层的 TCP，HTTP 在第四层；
2. OSI 分为七层，基本对应 TCP/IP，TCP 在第四层，HTTP 在第七层；
3. OSI 可以映射到 TCP/IP，但这期间一、五、六层消失了；
4. 日常交流的时候我们通常使用 OSI 模型，用四层、七层等术语；
5. HTTP 利用 TCP/IP 协议栈逐层打包再拆包，实现了数据传输，但下面的细节并不可见。



有一个辨别四层和七层比较好的（但不是绝对的）小窍门，“**两个凡是**”：凡是由操作系统负责处理的就是四层或四层以下，否则，凡是需要由应用程序（也就是你自己写代码）负责处理的就是七层

















































